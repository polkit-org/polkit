<refentry id="polkit-auth-1.1">
  <refentryinfo>
    <title>polkit-auth-1</title>
    <date>August 2007</date>
    <productname>PolicyKit-1</productname>
  </refentryinfo>
  
  <refmeta>
    <refentrytitle>polkit-auth-1</refentrytitle>
    <manvolnum>1</manvolnum>
    <refmiscinfo class="version"></refmiscinfo>
  </refmeta>
  
  <refnamediv>
    <refname>polkit-auth-1</refname>
    <refpurpose>Manage authorizations</refpurpose>
  </refnamediv>
  
  <refsynopsisdiv>
    <cmdsynopsis>
      <command>polkit-auth-1</command>
      <arg><option>--obtain <replaceable>action</replaceable></option></arg>
      <arg><option>--show-obtainable</option></arg>
      <arg><option><arg><option>--user <replaceable>user</replaceable></option></arg> --explicit</option></arg>
      <arg><option><arg><option>--user <replaceable>user</replaceable></option></arg> --explicit-detail</option></arg>
      <arg><option><arg><option>--user <replaceable>user</replaceable></option></arg> --grant <replaceable>action</replaceable></option><arg><option>--constraint <replaceable>constraint</replaceable></option></arg>*</arg>
      <arg><option><arg><option>--user <replaceable>user</replaceable></option></arg> --block <replaceable>action</replaceable></option><arg><option>--constraint <replaceable>constraint</replaceable></option></arg>*</arg>
      <arg><option><arg><option>--user <replaceable>user</replaceable></option></arg> --revoke <replaceable>action</replaceable></option></arg>
      <arg><option>--version</option></arg>
      <arg><option>--help</option></arg>
    </cmdsynopsis>
  </refsynopsisdiv>
  
  <refsect1>
    <title>DESCRIPTION</title> 
    <para>
      polkit-auth-1 is used to inspect, obtain, grant and revoke
      PolicyKit authorizations. If invoked without any options, the
      authorizations of the calling process will be printed.
    </para>
  </refsect1>
  
  <refsect1>
    <title>OPTIONS</title> 
    <variablelist>
      <varlistentry>
        <term><option>--obtain <replaceable>action</replaceable></option></term>
        <listitem>
          <para>
            Attempt to obtain an authorization through authentication
            for the given action. This is only useful for implicit
            authorizations requiring authentication; e.g. when an
            appropriate stanza in the defaults section of the .policy
            file for the action specifies
            <literal>auth_*</literal>. 
          </para>
          <para> 

            The gained authorization will be constrained as much as
            possible using the constraints specified in
            <xref linkend="polkit-auth-constraints"/>. For example, on
            a system running SELinux, if the caller runs uses this
            tool to obtain an authorization from a shell in a desktop
            in an active session, then constraints
            for <emphasis>local</emphasis>, <emphasis>active</emphasis>, <emphasis>exe</emphasis>
            and <emphasis>selinux_context</emphasis> will all be
            added.
          </para>
          <para> 
            If an Authentication Agent (such as the one from
            PolicyKit-gnome) is available in the session, it will used
            for authentication unless the environment variable
            POLKIT_AUTH_FORCE_TEXT is set. If the environment variable
            POLKIT_AUTH_GRANT_TO_PID is set, the authorization will be
            granted to that process id instead of the invoking process
            (e.g. the shell from which polkit-auth-1 is launched).
          </para>
        </listitem>
      </varlistentry>
      
      <varlistentry>
        <term><option>--show-obtainable</option></term>
        <listitem>
          <para>
             Prints all actions that can be obtained via
             authentication and for which an authorization does not
             exist.
          </para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option><arg><option>--user <replaceable>user</replaceable></option></arg> --explicit</option></term>
        <listitem>
          <para>
            Show explicit authorizations. Duplicates are not
            printed. If used with the <option>--user</option> option,
            the authorization
            <literal>org.freedesktop.policykit.read</literal> is required.
          </para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option><arg><option>--user <replaceable>user</replaceable></option></arg> --explicit-detail</option></term>
        <listitem>
          <para>
            Show detailed information about explicit
            authorizations. In contrast to
            the <literal>--explicit</literal>, duplicates are printed
            as several authorizations with different scope and
            constraints may exist.
          </para>
        </listitem>
      </varlistentry>
      
      <varlistentry>
        <term><option><arg><option>--user <replaceable>user</replaceable></option></arg> --grant <replaceable>action</replaceable></option><arg><option>--constraint <replaceable>constraint</replaceable></option></arg>*</term>
        <listitem>
          <para>
            Grant an authorization for an action. This is different
            than <literal>--obtain</literal> insofar that
            the <literal>defaults</literal> stanza of the .policy file
            is not consulted. Optionally, one or more constraints on
            the granted authorization can be specified, see
            <xref linkend="polkit-auth-constraints"/> for details. The
            authorization needed to grant authorizations is
            <literal>org.freedesktop.policykit.grant</literal>.
          </para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option><arg><option>--user <replaceable>user</replaceable></option></arg> --block <replaceable>action</replaceable></option><arg><option>--constraint <replaceable>constraint</replaceable></option></arg>*</term>
        <listitem>
          <para>
            Grant an negative authorization for an action. Negative
            authorizations are normally used to block users that would
            normally be authorized due to implicit
            authorizations. Optionally, one or more constraints on the
            granted authorization can be specified, see
            <xref linkend="polkit-auth-constraints"/> for details. The
            authorization needed to grant negative authorizations is
            <literal>org.freedesktop.policykit.grant</literal> if the
            "beneficiary" is another user.
          </para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><option><arg><option>--user <replaceable>user</replaceable></option></arg> --revoke <replaceable>action</replaceable></option></term>
        <listitem>
          <para>
            Revoke all authorizations for an action. If the user is
            not specified the calling user is used. The
            authorization <literal>org.freedesktop.policykit.revoke</literal>
            is needed to revoke authorizations from other users.
          </para>
        </listitem>
      </varlistentry>
      
      <varlistentry>
        <term><option>--version</option></term>
        <listitem>
          <para>
            Show version and exit.
          </para>
        </listitem>
      </varlistentry>
      
      <varlistentry>
        <term><option>--help</option></term>
        <listitem>
          <para>
            Show this information.
          </para>
        </listitem>
      </varlistentry>
    </variablelist>
  </refsect1>
  
  <refsect1 id="polkit-auth-constraints">
    <title>CONSTRAINTS</title> 
    <para>
      One can put one or more <emphasis>constraints</emphasis> on an
      authorization. They are used to limit where the authrorization
      applies. Presently the following constraints are supported

      <variablelist>
        <varlistentry>
          <term><option>--constraint local</option></term>
          <listitem>
            <para>
              The caller must be in a session on a local console
              attached to the system. For example processes that
              belong to remote XDMCP or ssh connections will fail to
              meet this constraint and as such the authorization with
              such a constraint won't apply.
            </para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><option>--constraint active</option></term>
          <listitem>
            <para>
              The caller must be in an active session. This is
              typically used with a <emphasis>local</emphasis>
              constraint to ensure that the caller is only authorized
              if his session is in the foreground. This is typically
              used for fast user switching (multiple sessions on the
              same console) to prevent inactive sessions from doing
              privileged operations like spying (using a webcam or a
              sound card) on the current active session.
            </para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><option>--constraint exe:<replaceable>/path/to/program</replaceable></option></term>
          <listitem>
            <para>
              The authorization is constrained to processes for where
              executable path (<literal>/proc/pid/exe</literal> on
              Linux) matches the given path. See
              <xref linkend="polkit-auth-notes"/> for limitations on
              why this may not be secure.
            </para>
          </listitem>
        </varlistentry>

        <varlistentry>
          <term><option>--constraint selinux_context:<replaceable>system_u:object_r:some_context_t</replaceable></option></term>
          <listitem>
            <para>
              The authorization is constrained to processes for where
              their SELinux security context matches the given
              context.
            </para>
          </listitem>
        </varlistentry>
      </variablelist>

    </para>
  </refsect1>

  <refsect1 id="polkit-auth-notes">
    <title>NOTES</title> 
    <para>
      Note that the executable path for a process is not necessary
      reliable information and as such shouldn't be relied on 100% to
      make a security decision. In fact, this information is only
      trustworthy in situations where the given binary is securely
      locked down meaning that 1) it can't
      be <literal>ptrace(2)</literal>'d; 2) libc secure mode kicks in
      (e.g <literal>LD_PRELOAD</literal> won't work); 3) there are no
      other attack vectors (e.g. GTK_MODULES, X11, CORBA, D-Bus) to
      patch running code into the process.
    </para>
    <para>
      In other words: the risk of relying on constraining an
      authorization to a path of an executable is high. Suppose that
      the program <literal>/usr/bin/gullible</literal> obtains an
      authorization via authentication for the action
      <literal>org.example.foo</literal>. We add a constraint to say
      that the gained authorization only applies to processes for whom
      <literal>/proc/pid/exe</literal> points to
      <literal>/usr/bin/gullible</literal>.
    </para>
    <para>
      Now enter <literal>/usr/bin/evil</literal>. It knows that the
      program <literal>/usr/bin/gullible</literal> is not "securely
      locked down" (per the definition in the above paragraph). So
      <literal>/usr/bin/evil</literal> simply sets
      <literal>LD_PRELOAD</literal> and execs
      <literal>/usr/bin/gullible</literal> and it can now run code in a
      process where <literal>/proc/pid/exe</literal> points to
      <literal>/usr/bin/gullible</literal>. Thus, the recently gained
      authorization for <literal>org.example.foo</literal> applies. Also,
      <literal>/usr/bin/evil</literal> could use a host of other attack
      vectors to run it's own code under the disguise of pretending to be
      <literal>/usr/bin/gullible</literal>.
    </para>
    <para>
      Specifically for interpreted languages like Python and Mono it
      is the case that <literal>/proc/pid/exe</literal> always points
      to
      <literal>/usr/bin/python</literal>
      resp. <literal>/usr/bin/mono</literal>. Thus, it's not very useful
      to rely on that the result for this function if you want to
      constrain an authorization to
      e.g. <literal>/usr/bin/tomboy</literal> or
      <literal>/usr/bin/banshee</literal>.
    </para>
    <para>
      It is however possible to write programs that are "securely
      locked down" (per the definition in the above paragraph); for
      example all properly written <literal>setuid</literal>
      and <literal>setgid</literal> programs are written in this way.
    </para>
  </refsect1>

  <refsect1>
    <title>COMPLETION</title> 
    <para>
      PolicyKit ships with a collection of shell functions such that
      completion on users, actions and constraints work when using the
      <citerefentry>
        <refentrytitle>bash</refentrytitle><manvolnum>1</manvolnum>
      </citerefentry>
      shell. For completion to properly work for polkit-auth-1,
      arguments should be entered in the order specified in this
      manual page; for example. <option>--user</option> should be
      specified before <option>--revoke</option> to complete only on
      the authorizations the given user has. Note that if the calling
      user lacks the <literal>org.freedesktop.policykit.read</literal>
      authorization, the completion function will fall back to
      completing on all registered actions.
    </para>
  </refsect1>

  <refsect1>
    <title>BUGS</title> 
    <para>
      Please send bug reports to either the distribution or the
      polkit-devel mailing list,
      see <ulink url="http://lists.freedesktop.org/mailman/listinfo/polkit-devel"/>.
      to subscribe.
    </para>
  </refsect1>
  
  <refsect1>
    <title>SEE ALSO</title>
    <para>
      <citerefentry>
        <refentrytitle>PolicyKit-1</refentrytitle><manvolnum>8</manvolnum>
      </citerefentry>, 
      <citerefentry>
        <refentrytitle>polkit-action-1</refentrytitle><manvolnum>1</manvolnum>
      </citerefentry>
    </para>
  </refsect1>
</refentry>
